<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TaskFlow — Lightweight Task Manager</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --primary: #4f46e5;
      --accent: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    .task-card { transition: transform .18s ease, box-shadow .18s ease; }
    .task-card:hover { transform: translateY(-4px); box-shadow: 0 12px 22px rgba(2,6,23,0.08); }

    @keyframes fadeInUp { from { opacity: 0; transform: translateY(8px);} to { opacity:1; transform: translateY(0);} }
    .fade-in { animation: fadeInUp .22s ease both; }

    .priority-high{ border-left: 4px solid var(--danger); }
    .priority-medium{ border-left: 4px solid var(--warning); }
    .priority-low{ border-left: 4px solid var(--accent); }

    @media (max-width:640px){
      .max-w-md{ max-width: 94vw; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <div class="container mx-auto max-w-6xl p-6">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <img src="https://placehold.co/40x40" alt="logo" class="rounded-full">
        <div>
          <h1 class="text-2xl font-bold">TaskFlow</h1>
          <p class="text-sm text-gray-600">Lightweight task manager — track, filter, and finish.</p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <button id="statsBtn" class="bg-white px-3 py-2 rounded-lg shadow-sm border border-gray-200 hover:bg-gray-50">
          <i class="fas fa-chart-pie text-indigo-600"></i>
          <span class="hidden md:inline ml-2">Stats</span>
        </button>

        <button id="themeToggle" title="Toggle theme" class="p-2 rounded-full bg-white shadow-sm border border-gray-200 hover:bg-gray-50">
          <i id="themeIcon" class="fas fa-moon text-indigo-600"></i>
        </button>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Left column: Add + Filters -->
      <aside class="lg:col-span-1 space-y-4">
        <!-- Add Task -->
        <section class="bg-white rounded-xl p-5 shadow-sm border border-gray-200">
          <h2 class="text-lg font-semibold mb-3">Add New Task</h2>
          <form id="taskForm" class="space-y-3" autocomplete="off">
            <div>
              <label for="taskTitle" class="block text-sm font-medium text-gray-700">Title</label>
              <input id="taskTitle" required type="text" class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-indigo-400" placeholder="e.g., Finish assignment">
            </div>

            <div>
              <label for="taskDescription" class="block text-sm font-medium text-gray-700">Description</label>
              <textarea id="taskDescription" rows="2" class="w-full px-3 py-2 border rounded-md" placeholder="Short details (optional)"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label for="taskPriority" class="block text-sm font-medium text-gray-700">Priority</label>
                <select id="taskPriority" class="w-full px-3 py-2 border rounded-md">
                  <option value="low">Low</option>
                  <option value="medium" selected>Medium</option>
                  <option value="high">High</option>
                </select>
              </div>

              <div>
                <label for="taskDueDate" class="block text-sm font-medium text-gray-700">Due</label>
                <input id="taskDueDate" type="date" class="w-full px-3 py-2 border rounded-md">
              </div>
            </div>

            <div>
              <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700">
                <i class="fas fa-plus mr-2"></i> Add Task
              </button>
            </div>
          </form>
        </section>

        <!-- Filters -->
        <section class="bg-white rounded-xl p-5 shadow-sm border border-gray-200">
          <h2 class="text-lg font-semibold mb-3">Filters</h2>

          <div class="space-y-2">
            <div class="text-sm font-medium text-gray-700">Status</div>
            <div class="flex flex-col gap-2">
              <label class="inline-flex items-center"><input name="statusFilter" type="radio" value="all" checked class="mr-2">All</label>
              <label class="inline-flex items-center"><input name="statusFilter" type="radio" value="pending" class="mr-2">Pending</label>
              <label class="inline-flex items-center"><input name="statusFilter" type="radio" value="in-progress" class="mr-2">In Progress</label>
              <label class="inline-flex items-center"><input name="statusFilter" type="radio" value="completed" class="mr-2">Completed</label>
            </div>
          </div>

          <div class="mt-4">
            <label for="priorityFilter" class="block text-sm font-medium text-gray-700">Priority</label>
            <select id="priorityFilter" class="w-full px-3 py-2 border rounded-md">
              <option value="all">All</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
          </div>

          <div class="mt-4">
            <label for="searchInput" class="block text-sm font-medium text-gray-700">Search</label>
            <input id="searchInput" type="search" placeholder="Search title or description" class="w-full px-3 py-2 border rounded-md">
          </div>
        </section>
      </aside>

      <!-- Right column: Tasks + Stats summary -->
      <main class="lg:col-span-3 space-y-4">
        <!-- Quick stats row -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="p-3 rounded-lg bg-indigo-50">
            <div class="text-xs text-indigo-600">Total</div>
            <div id="totalTasks" class="text-2xl font-bold">0</div>
          </div>
          <div class="p-3 rounded-lg bg-green-50">
            <div class="text-xs text-green-600">Completed</div>
            <div id="completedTasks" class="text-2xl font-bold">0</div>
          </div>
          <div class="p-3 rounded-lg bg-yellow-50">
            <div class="text-xs text-yellow-600">In Progress</div>
            <div id="inProgressTasks" class="text-2xl font-bold">0</div>
          </div>
          <div class="p-3 rounded-lg bg-red-50">
            <div class="text-xs text-red-600">Overdue</div>
            <div id="overdueTasks" class="text-2xl font-bold">0</div>
          </div>
        </div>

        <!-- Task list -->
        <section id="taskList" class="space-y-3">
          <!-- empty state -->
          <div id="emptyState" class="text-center py-12">
            <img src="https://placehold.co/300x200" alt="empty" class="mx-auto mb-4 rounded-lg">
            <h3 class="text-xl font-medium text-gray-700">No tasks yet</h3>
            <p class="text-gray-500">Use the form on the left to add your first task.</p>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Task Detail Modal -->
  <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-start mb-4">
        <h3 id="modalTitle" class="text-lg font-bold">Task</h3>
        <button id="closeModal" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
      </div>
      <div id="modalBody" class="space-y-3 text-sm text-gray-700">
        <!-- filled dynamically -->
      </div>

      <div class="mt-6 flex gap-3">
        <button id="modalEdit" class="flex-1 bg-indigo-600 text-white py-2 rounded-md"><i class="fas fa-edit mr-2"></i>Edit</button>
        <button id="modalDelete" class="flex-1 bg-red-600 text-white py-2 rounded-md"><i class="fas fa-trash mr-2"></i>Delete</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal (re-uses a simple form) -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-start mb-4">
        <h3 class="text-lg font-bold">Edit Task</h3>
        <button id="closeEdit" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
      </div>

      <form id="editForm" class="space-y-3">
        <input id="editTaskId" type="hidden">
        <div>
          <label class="block text-sm font-medium text-gray-700">Title</label>
          <input id="editTaskTitle" required type="text" class="w-full px-3 py-2 border rounded-md">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Description</label>
          <textarea id="editTaskDescription" rows="2" class="w-full px-3 py-2 border rounded-md"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700">Priority</label>
            <select id="editTaskPriority" class="w-full px-3 py-2 border rounded-md">
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Status</label>
            <select id="editTaskStatus" class="w-full px-3 py-2 border rounded-md">
              <option value="pending">Pending</option>
              <option value="in-progress">In Progress</option>
              <option value="completed">Completed</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Due</label>
          <input id="editTaskDueDate" type="date" class="w-full px-3 py-2 border rounded-md">
        </div>

        <div>
          <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-md">Save changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const taskForm = document.getElementById('taskForm');
    const taskTitle = document.getElementById('taskTitle');
    const taskDescription = document.getElementById('taskDescription');
    const taskPriority = document.getElementById('taskPriority');
    const taskDueDate = document.getElementById('taskDueDate');

    const taskList = document.getElementById('taskList');
    const emptyState = document.getElementById('emptyState');

    const statusFilterEls = document.getElementsByName('statusFilter');
    const priorityFilter = document.getElementById('priorityFilter');
    const searchInput = document.getElementById('searchInput');

    const totalTasksEl = document.getElementById('totalTasks');
    const completedTasksEl = document.getElementById('completedTasks');
    const inProgressTasksEl = document.getElementById('inProgressTasks');
    const overdueTasksEl = document.getElementById('overdueTasks');

    const statsBtn = document.getElementById('statsBtn');
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');

    const taskModal = document.getElementById('taskModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const closeModal = document.getElementById('closeModal');
    const modalEditBtn = document.getElementById('modalEdit');
    const modalDeleteBtn = document.getElementById('modalDelete');

    const editModal = document.getElementById('editModal');
    const closeEdit = document.getElementById('closeEdit');
    const editForm = document.getElementById('editForm');
    const editTaskId = document.getElementById('editTaskId');
    const editTaskTitle = document.getElementById('editTaskTitle');
    const editTaskDescription = document.getElementById('editTaskDescription');
    const editTaskPriority = document.getElementById('editTaskPriority');
    const editTaskStatus = document.getElementById('editTaskStatus');
    const editTaskDueDate = document.getElementById('editTaskDueDate');

    let tasks = loadFromStorage(); 
    let currentTaskId = null;      

    
    function saveToStorage() {
      localStorage.setItem('taskflow_tasks_v1', JSON.stringify(tasks));
    }

    function loadFromStorage() {
      try {
        const raw = localStorage.getItem('taskflow_tasks_v1');
        return raw ? JSON.parse(raw) : [];
      } catch (err) {
        console.error('Failed to load tasks:', err);
        return [];
      }
    }

    // human-friendly date formatting (local to user)
    function formatDateIsoToReadable(isoDate, withTime = false) {
      if (!isoDate) return 'No due date';
      const dt = new Date(isoDate);
      const opts = { year: 'numeric', month: 'short', day: 'numeric' };
      if (withTime) { opts.hour='2-digit'; opts.minute='2-digit'; }
      return dt.toLocaleString(undefined, opts);
    }

    function isOverdue(task) {
      if (!task.dueDate) return false;
      if (task.status === 'completed') return false;
      const today = new Date();
      const due = new Date(task.dueDate);
      // compare dates without time by zeroing time component (so due today isn't overdue)
      return (due.setHours(0,0,0,0) < today.setHours(0,0,0,0));
    }

    // generate a simple unique id (sufficient for local usage)
    function makeId() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2,7);
    }

    function renderTasks(filtered = null) {
      const list = filtered ?? tasks.slice().reverse(); // newest first
      taskList.innerHTML = '';
      if (list.length === 0) {
        emptyState.style.display = '';
        return;
      } else {
        emptyState.style.display = 'none';
      }

      for (const task of list) {
        const overdue = isOverdue(task);
        const card = document.createElement('article');
        card.className = `task-card bg-white rounded-xl p-4 border border-gray-200 flex justify-between items-start ${overdue ? 'opacity-95' : ''} fade-in`;
        card.dataset.id = task.id;

        const left = document.createElement('div');
        left.className = 'flex-1 pr-4';
        left.innerHTML = `
          <div class="flex items-center gap-3 mb-1">
            <div class="w-3 h-3 rounded-full ${task.priority === 'high' ? 'bg-red-500' : task.priority === 'medium' ? 'bg-yellow-500' : 'bg-green-500'}"></div>
            <h3 class="font-medium text-gray-800">${escapeHtml(task.title)}</h3>
          </div>
          <p class="text-sm text-gray-500 truncate">${escapeHtml(task.description || '')}</p>
          <div class="flex items-center gap-3 mt-3 text-xs">
            <span class="px-2 py-1 rounded-full ${task.status === 'completed' ? 'bg-green-100 text-green-800' : task.status === 'in-progress' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
              ${statusLabel(task.status)}
            </span>
            ${task.dueDate ? `<span class="${overdue ? 'text-red-600 font-medium' : 'text-gray-500'}"><i class="far fa-calendar-alt mr-1"></i>${formatDateIsoToReadable(task.dueDate)}</span>` : ''}
          </div>
        `;

        const right = document.createElement('div');
        right.className = 'flex flex-col gap-2';
        right.innerHTML = `
          <button class="btn-open text-gray-400 hover:text-indigo-600 p-2 rounded-full" title="Open">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn-quick-edit text-gray-400 hover:text-indigo-600 p-2 rounded-full" title="Quick edit">
            <i class="fas fa-pencil-alt"></i>
          </button>
        `;

        card.appendChild(left);
        card.appendChild(right);

        card.addEventListener('click', (e) => {
          if (e.target.closest('.btn-open') || e.target.closest('.btn-quick-edit')) return;
          openTaskModal(task.id);
        });

        right.querySelector('.btn-open').addEventListener('click', (e) => {
          e.stopPropagation();
          openTaskModal(task.id);
        });

        right.querySelector('.btn-quick-edit').addEventListener('click', (e) => {
          e.stopPropagation();
          openEditModal(task.id);
        });

        taskList.appendChild(card);
      }
    }

    // small helper to avoid injecting raw HTML strings from user inputs
    function escapeHtml(str = '') {
      return String(str).replace(/[&<>"'`=\/]/g, s => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
      })[s]);
    }

    function statusLabel(status){
      if (status === 'in-progress') return 'In Progress';
      return status.charAt(0).toUpperCase() + status.slice(1);
    }

    // ---- CRUD operations ----
    function addTaskFromForm(e) {
      e.preventDefault();
      const title = taskTitle.value.trim();
      if (!title) { alert('Please give the task a title'); return; }

      const newTask = {
        id: makeId(),
        title,
        description: taskDescription.value.trim() || '',
        priority: taskPriority.value,
        status: 'pending',
        createdAt: new Date().toISOString(),
        dueDate: taskDueDate.value ? new Date(taskDueDate.value).toISOString() : null
      };

      tasks.push(newTask);
      saveToStorage();
      renderWithFilters(); // show after adding
      updateStats();

      // small UI feedback
      taskForm.reset();
      taskTitle.focus();
    }

    function openTaskModal(id) {
      const t = tasks.find(x => x.id === id);
      if (!t) return;
      currentTaskId = id;
      modalTitle.textContent = t.title;
      modalBody.innerHTML = `
        <p class="text-gray-700">${escapeHtml(t.description || 'No description')}</p>
        <div class="grid grid-cols-2 gap-3 mt-4 text-sm text-gray-600">
          <div><strong>Priority:</strong> ${t.priority}</div>
          <div><strong>Status:</strong> ${statusLabel(t.status)}</div>
          <div><strong>Created:</strong> ${formatDateIsoToReadable(t.createdAt, true)}</div>
          <div><strong>Due:</strong> ${t.dueDate ? formatDateIsoToReadable(t.dueDate) : 'No due date'}</div>
        </div>
      `;
      taskModal.classList.remove('hidden');
      taskModal.classList.add('flex');
    }

    function closeTaskModal() {
      taskModal.classList.add('hidden');
      taskModal.classList.remove('flex');
      currentTaskId = null;
    }

    function openEditModal(id) {
      const t = tasks.find(x => x.id === id);
      if (!t) return;
      currentTaskId = id;
      editTaskId.value = t.id;
      editTaskTitle.value = t.title;
      editTaskDescription.value = t.description;
      editTaskPriority.value = t.priority;
      editTaskStatus.value = t.status;
      editTaskDueDate.value = t.dueDate ? t.dueDate.substring(0,10) : '';
      editModal.classList.remove('hidden');
      editModal.classList.add('flex');

      // close the read-only modal if open
      closeTaskModal();
    }

    function closeEditModal() {
      editModal.classList.add('hidden');
      editModal.classList.remove('flex');
      editForm.reset();
      currentTaskId = null;
    }

    function saveEdit(e) {
      e.preventDefault();
      const id = editTaskId.value || currentTaskId;
      const idx = tasks.findIndex(t => t.id === id);
      if (idx === -1) return;

      tasks[idx].title = editTaskTitle.value.trim() || tasks[idx].title;
      tasks[idx].description = editTaskDescription.value.trim();
      tasks[idx].priority = editTaskPriority.value;
      tasks[idx].status = editTaskStatus.value;
      tasks[idx].dueDate = editTaskDueDate.value ? new Date(editTaskDueDate.value).toISOString() : null;

      saveToStorage();
      renderWithFilters();
      updateStats();
      closeEditModal();
    }

    function deleteCurrentFromModal() {
      if (!currentTaskId) return;
      if (!confirm('Delete this task?')) return;
      tasks = tasks.filter(t => t.id !== currentTaskId);
      saveToStorage();
      renderWithFilters();
      updateStats();
      closeTaskModal();
    }

    // ---- Filtering/searching (used by UI controls) ----
    function getFilterValues() {
      const selectedStatus = Array.from(statusFilterEls).find(r => r.checked)?.value || 'all';
      const selectedPriority = priorityFilter.value || 'all';
      const q = (searchInput.value || '').trim().toLowerCase();
      return { selectedStatus, selectedPriority, q };
    }

    function applyFiltersArray(arr) {
      const { selectedStatus, selectedPriority, q } = getFilterValues();
      return arr.filter(t => {
        // status filter
        if (selectedStatus !== 'all' && t.status !== selectedStatus) return false;
        // priority filter
        if (selectedPriority !== 'all' && t.priority !== selectedPriority) return false;
        // search match in title or description
        if (q) {
          const hay = (t.title + ' ' + (t.description || '')).toLowerCase();
          if (!hay.includes(q)) return false;
        }
        return true;
      });
    }

    // debounce helper to limit search/filter re-renders while typing
    function debounce(fn, wait = 200) {
      let id;
      return (...args) => {
        clearTimeout(id);
        id = setTimeout(() => fn(...args), wait);
      };
    }

    // orchestrator: get filtered array and call renderTasks
    const renderWithFilters = debounce(() => {
      const filtered = applyFiltersArray(tasks.slice().reverse()); // newest first
      renderTasks(filtered);
    }, 120);

    // ---- Stats update ----
    function updateStats() {
      totalTasksEl.textContent = tasks.length;
      completedTasksEl.textContent = tasks.filter(t => t.status === 'completed').length;
      inProgressTasksEl.textContent = tasks.filter(t => t.status === 'in-progress').length;
      const today = new Date();
      const overdueCount = tasks.filter(t => t.dueDate && t.status !== 'completed' && (new Date(t.dueDate).setHours(0,0,0,0) < today.setHours(0,0,0,0))).length;
      overdueTasksEl.textContent = overdueCount;
    }

    // ---- Theme toggle (simple dark class) ----
    function initTheme() {
      const saved = localStorage.getItem('taskflow_theme') || 'light';
      if (saved === 'dark') {
        document.documentElement.classList.add('dark');
        themeIcon.className = 'fas fa-sun text-yellow-400';
      } else {
        document.documentElement.classList.remove('dark');
        themeIcon.className = 'fas fa-moon text-indigo-600';
      }
    }
    function toggleTheme() {
      if (document.documentElement.classList.contains('dark')) {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('taskflow_theme','light');
      } else {
        document.documentElement.classList.add('dark');
        localStorage.setItem('taskflow_theme','dark');
      }
      initTheme();
    }

    // ---- Init & event wiring ----
    function init() {
      // initial render
      renderWithFilters();
      updateStats();
      initTheme();

      // add listeners
      taskForm.addEventListener('submit', addTaskFromForm);

      // filters & search
      Array.from(statusFilterEls).forEach(r => r.addEventListener('change', renderWithFilters));
      priorityFilter.addEventListener('change', renderWithFilters);
      searchInput.addEventListener('input', renderWithFilters);

      // modal controls
      closeModal.addEventListener('click', closeTaskModal);
      closeEdit.addEventListener('click', closeEditModal);
      modalDeleteBtn.addEventListener('click', deleteCurrentFromModal);
      modalEditBtn.addEventListener('click', () => openEditModal(currentTaskId));

      editForm.addEventListener('submit', saveEdit);

      statsBtn.addEventListener('click', () => {
        alert(`Tasks: ${tasks.length}\nCompleted: ${tasks.filter(t => t.status === 'completed').length}\nIn Progress: ${tasks.filter(t => t.status === 'in-progress').length}\nOverdue: ${overdueTasksEl.textContent}`);
      });

      themeToggle.addEventListener('click', toggleTheme);
    }

    init();

  </script>
</body>
</html>
